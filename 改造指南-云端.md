# DroidRun Pythonæ¡†æ¶ - äº‘ç«¯åŒ–æ”¹é€ æŒ‡å—

## ğŸ“‹ æ”¹é€ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•å°†DroidRun Pythonæ¡†æ¶ä»åŸºäºADBçš„æœ¬åœ°æ§åˆ¶æ¶æ„æ”¹é€ ä¸ºäº‘ç«¯WebSocketå®æ—¶é€šä¿¡æ¶æ„ã€‚æ”¹é€ åï¼Œæ¡†æ¶å°†ä½œä¸ºäº‘ç«¯AIä»£ç†æœåŠ¡å™¨ï¼Œé€šè¿‡WebSocketä¸Androidè®¾å¤‡è¿›è¡Œå®æ—¶é€šä¿¡ã€‚

### ğŸ¯ æ”¹é€ ç›®æ ‡

- **é€šä¿¡æ–¹å¼è½¬æ¢**: ä»ADBå‘½ä»¤è½¬ä¸ºWebSocketå®æ—¶é€šä¿¡
- **æ¶æ„äº‘ç«¯åŒ–**: éƒ¨ç½²ä¸ºäº‘ç«¯FastAPIæœåŠ¡
- **å·¥å…·å±‚é‡æ„**: æ–°å¢WebSocketToolsæ›¿ä»£AdbTools
- **çŠ¶æ€ç®¡ç†ä¼˜åŒ–**: å®æ—¶çŠ¶æ€åŒæ­¥å’Œç®¡ç†
- **æ•°æ®åº“é›†æˆ**: Supabaseç”¨æˆ·å’Œè®¾å¤‡ç®¡ç†

## ğŸ—ï¸ æ¶æ„å˜åŒ–å¯¹æ¯”

### åŸæ¶æ„ (æœ¬åœ°ADBæ¨¡å¼)
```mermaid
graph LR
    A[ç”¨æˆ·CLI] --> B[DroidAgent]
    B --> C[AdbTools]
    C --> D[ADBå‘½ä»¤]
    D --> E[Android Portal]
    E --> F[æ— éšœç¢æœåŠ¡]
    F --> G[UIæ“ä½œ]

    style A fill:#ffcccc
    style D fill:#ffcccc
    style E fill:#ffcccc
```

### æ–°æ¶æ„ (äº‘ç«¯WebSocketæ¨¡å¼)
```mermaid
graph TB
    subgraph "ç”¨æˆ·ç«¯"
        A[Android APPç•Œé¢]
        B[ä»»åŠ¡è¾“å…¥]
        C[çŠ¶æ€æ˜¾ç¤º]
    end

    subgraph "é€šä¿¡å±‚"
        D[WebSocketå®¢æˆ·ç«¯]
        E[WebSocketè¿æ¥]
        F[æ¶ˆæ¯é˜Ÿåˆ—]
    end

    subgraph "äº‘ç«¯æœåŠ¡å™¨"
        G[FastAPIæœåŠ¡å™¨]
        H[WebSocketå¤„ç†å™¨]
        I[è¿æ¥ç®¡ç†å™¨]
        J[DroidAgentåè°ƒå™¨]
    end

    subgraph "AIå¤„ç†å±‚"
        K[PlannerAgentè§„åˆ’]
        L[CodeActAgentæ‰§è¡Œ]
        M[LLMæ¨ç†å¼•æ“]
        N[å·¥å…·è°ƒç”¨å±‚]
    end

    subgraph "å·¥å…·ç³»ç»Ÿ"
        O[WebSocketTools]
        P[è®¾å¤‡çŠ¶æ€ç®¡ç†]
        Q[å‘½ä»¤æ‰§è¡Œå™¨]
    end

    subgraph "æ•°æ®å­˜å‚¨"
        R[Supabaseæ•°æ®åº“]
        S[è®¾å¤‡æ³¨å†Œè¡¨]
        T[ä»»åŠ¡æ—¥å¿—]
        U[ç”¨æˆ·ç®¡ç†]
    end

    subgraph "è®¾å¤‡ç«¯"
        V[Androidè®¾å¤‡]
        W[æ— éšœç¢æœåŠ¡]
        X[UIæ“ä½œæ‰§è¡Œ]
        Y[çŠ¶æ€åé¦ˆ]
    end

    A --> B
    B --> D
    D --> E
    E --> G
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    L --> M
    M --> N
    N --> O
    O --> P
    O --> Q

    G --> R
    R --> S
    R --> T
    R --> U

    Q --> E
    E --> D
    D --> V
    V --> W
    W --> X
    X --> Y
    Y --> D
    D --> C

    style A fill:#e1f5fe
    style G fill:#f3e5f5
    style J fill:#e8f5e8
    style O fill:#fff3e0
    style R fill:#fce4ec
    style V fill:#e0f2f1
```

### ğŸ”§ æ ¸å¿ƒç»„ä»¶æ¶æ„

```mermaid
graph TB
    subgraph "FastAPI WebSocketæœåŠ¡å™¨"
        A[ä¸»æœåŠ¡å™¨ main.py]
        B[WebSocketå¤„ç†å™¨]
        C[è¿æ¥ç®¡ç†å™¨]
        D[è·¯ç”±ç®¡ç†]
    end

    subgraph "AIæ™ºèƒ½ä½“ç³»ç»Ÿ"
        E[DroidAgent åè°ƒå™¨]
        F[PlannerAgent è§„åˆ’å™¨]
        G[CodeActAgent æ‰§è¡Œå™¨]
        H[Workflow å·¥ä½œæµ]
    end

    subgraph "å·¥å…·ç³»ç»Ÿ"
        I[Tools æŠ½è±¡åŸºç±»]
        J[WebSocketTools å®ç°]
        K[è®¾å¤‡çŠ¶æ€ç®¡ç†]
        L[å‘½ä»¤æ‰§è¡Œå™¨]
    end

    subgraph "LLMé›†æˆå±‚"
        M[LLMåŠ è½½å™¨]
        N[OpenAIé›†æˆ]
        O[Anthropicé›†æˆ]
        P[Google Geminié›†æˆ]
        Q[Ollamaé›†æˆ]
    end

    subgraph "æ•°æ®ç®¡ç†"
        R[Supabaseå®¢æˆ·ç«¯]
        S[è®¾å¤‡æ³¨å†Œç®¡ç†]
        T[ä»»åŠ¡æ—¥å¿—è®°å½•]
        U[ç”¨æˆ·è®¤è¯]
    end

    subgraph "é…ç½®å’Œç›‘æ§"
        V[é…ç½®ç®¡ç†å™¨]
        W[æ—¥å¿—ç³»ç»Ÿ]
        X[æ€§èƒ½ç›‘æ§]
        Y[é”™è¯¯å¤„ç†]
    end

    A --> B
    B --> C
    C --> E
    E --> F
    E --> G
    F --> H
    G --> H
    H --> I
    I --> J
    J --> K
    J --> L

    E --> M
    M --> N
    M --> O
    M --> P
    M --> Q

    A --> R
    R --> S
    R --> T
    R --> U

    A --> V
    V --> W
    V --> X
    V --> Y

    style E fill:#e1f5fe
    style J fill:#f3e5f5
    style A fill:#e8f5e8
    style R fill:#fff3e0
```

### ğŸ“Š æ•°æ®æµæ¶æ„

```mermaid
sequenceDiagram
    participant A as Android APP
    participant W as WebSocketè¿æ¥
    participant F as FastAPIæœåŠ¡å™¨
    participant D as DroidAgent
    participant P as PlannerAgent
    participant C as CodeActAgent
    participant T as WebSocketTools
    participant S as Supabaseæ•°æ®åº“

    A->>W: æäº¤ä»»åŠ¡è¯·æ±‚
    W->>F: WebSocketæ¶ˆæ¯
    F->>D: åˆ›å»ºä»»åŠ¡å®ä¾‹
    D->>S: è®°å½•ä»»åŠ¡å¼€å§‹

    D->>P: ä»»åŠ¡è§„åˆ’è¯·æ±‚
    P->>P: LLMæ¨ç†è§„åˆ’
    P->>D: è¿”å›æ‰§è¡Œè®¡åˆ’

    loop æ‰§è¡Œæ­¥éª¤
        D->>C: æ‰§è¡Œå•æ­¥ä»»åŠ¡
        C->>T: è°ƒç”¨è®¾å¤‡å·¥å…·
        T->>W: å‘é€è®¾å¤‡å‘½ä»¤
        W->>A: æ‰§è¡ŒUIæ“ä½œ
        A->>W: è¿”å›æ‰§è¡Œç»“æœ
        W->>T: æ¥æ”¶æ“ä½œç»“æœ
        T->>C: è¿”å›æ‰§è¡ŒçŠ¶æ€
        C->>D: æŠ¥å‘Šæ­¥éª¤å®Œæˆ
        D->>S: æ›´æ–°ä»»åŠ¡è¿›åº¦
        D->>W: å‘é€è¿›åº¦æ›´æ–°
        W->>A: æ˜¾ç¤ºæ‰§è¡Œè¿›åº¦
    end

    D->>S: è®°å½•ä»»åŠ¡å®Œæˆ
    D->>W: å‘é€æœ€ç»ˆç»“æœ
    W->>A: æ˜¾ç¤ºä»»åŠ¡ç»“æœ

    Note over P: AIè§„åˆ’å’Œæ¨ç†
    Note over C: é€æ­¥æ‰§è¡Œå’Œåé¦ˆ
    Note over T: è®¾å¤‡çŠ¶æ€åŒæ­¥
    Note over S: æ•°æ®æŒä¹…åŒ–
```

### ğŸ”„ WebSocketé€šä¿¡åè®®

```mermaid
graph LR
    subgraph "Androidç«¯æ¶ˆæ¯"
        A1[new_task]
        A2[execution_result]
        A3[state_update]
        A4[ping]
        A5[device_register]
    end

    subgraph "æœåŠ¡å™¨ç«¯æ¶ˆæ¯"
        S1[command]
        S2[task_status]
        S3[task_progress]
        S4[task_complete]
        S5[pong]
        S6[error]
    end

    A1 --> S2
    S1 --> A2
    A3 --> S3
    A4 --> S5
    A5 --> S2
    S6 --> A1

    style A1 fill:#e1f5fe
    style S1 fill:#f3e5f5
```

## ğŸ”§ æ ¸å¿ƒæ”¹é€ ä»»åŠ¡

### 1. æ–°å¢WebSocketToolsç±»

#### 1.1 åˆ›å»ºWebSocketToolsåŸºç¡€ç»“æ„
**æ–‡ä»¶ä½ç½®**: `droidrun/tools/websocket.py`

```python
from typing import Dict, Any, Optional
from fastapi import WebSocket
import asyncio
import json
import logging
from .tools import Tools

class WebSocketTools(Tools):
    """äº‘ç«¯ç‰ˆæœ¬çš„Toolsï¼Œé€šè¿‡WebSocketä¸è®¾å¤‡å®æ—¶é€šä¿¡"""
    
    def __init__(self, websocket: WebSocket, device_id: str):
        self.websocket = websocket
        self.device_id = device_id
        self.current_state = None
        self.waiting_for_result = False
        self.result_event = asyncio.Event()
        self.execution_result = None
        
        # ç»§æ‰¿è‡ªToolsçš„å±æ€§
        self.last_screenshot = None
        self.reason = None
        self.success = None
        self.finished = False
        self.memory: List[str] = []
        self.screenshots: List[Dict[str, Any]] = []
```

#### 1.2 å®ç°æ ¸å¿ƒæ–¹æ³•
éœ€è¦å®ç°ToolsæŠ½è±¡åŸºç±»çš„æ‰€æœ‰æ–¹æ³•ï¼š

- `get_state()` - è·å–è®¾å¤‡çŠ¶æ€
- `tap_by_index()` - ç‚¹å‡»æ“ä½œ
- `input_text()` - æ–‡æœ¬è¾“å…¥
- `swipe()` - æ»‘åŠ¨æ“ä½œ
- `press_key()` - æŒ‰é”®æ“ä½œ
- `take_screenshot()` - æˆªå›¾
- `get_installed_packages()` - è·å–åº”ç”¨åˆ—è¡¨
- `launch_app()` - å¯åŠ¨åº”ç”¨

#### 1.3 WebSocketé€šä¿¡åè®®è®¾è®¡
**æ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ–**:

```python
# å‘é€ç»™Androidçš„æŒ‡ä»¤æ ¼å¼
{
    "type": "command",
    "action": "tap_by_index",
    "params": {"index": 5},
    "request_id": "uuid-string"
}

# Androidè¿”å›çš„ç»“æœæ ¼å¼
{
    "type": "result",
    "request_id": "uuid-string", 
    "success": true,
    "data": {...},
    "new_state": {...}
}
```

### 2. FastAPI WebSocketæœåŠ¡å™¨

#### 2.1 åˆ›å»ºä¸»æœåŠ¡å™¨æ–‡ä»¶
**æ–‡ä»¶ä½ç½®**: `droidrun/server/main.py`

```python
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.middleware.cors import CORSMiddleware
import asyncio
import logging
from typing import Dict
from ..agent.droid import DroidAgent
from ..agent.utils.llm_picker import load_llm
from ..tools.websocket import WebSocketTools
from .database import SupabaseManager

app = FastAPI(title="DroidRun Cloud Server")

# æ·»åŠ CORSä¸­é—´ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# å…¨å±€è¿æ¥ç®¡ç†å™¨
class ConnectionManager:
    def __init__(self):
        self.active_connections: Dict[str, WebSocket] = {}
        self.device_agents: Dict[str, DroidAgent] = {}
    
    async def connect(self, websocket: WebSocket, device_id: str):
        await websocket.accept()
        self.active_connections[device_id] = websocket
        
    def disconnect(self, device_id: str):
        if device_id in self.active_connections:
            del self.active_connections[device_id]
        if device_id in self.device_agents:
            del self.device_agents[device_id]

manager = ConnectionManager()
```

#### 2.2 WebSocketç«¯ç‚¹å®ç°
```python
@app.websocket("/ws/device/{device_id}")
async def device_websocket(websocket: WebSocket, device_id: str):
    """è®¾å¤‡WebSocketè¿æ¥ç«¯ç‚¹"""
    await manager.connect(websocket, device_id)
    
    # åˆ›å»ºè®¾å¤‡ä¸“ç”¨çš„Tools
    tools = WebSocketTools(websocket, device_id)
    
    try:
        while True:
            # æ¥æ”¶æ¥è‡ªAndroidçš„æ¶ˆæ¯
            message = await websocket.receive_json()
            
            if message["type"] == "new_task":
                # å¤„ç†æ–°ä»»åŠ¡
                await handle_new_task(device_id, message, tools)
                
            elif message["type"] == "execution_result":
                # å¤„ç†æ‰§è¡Œç»“æœ
                await handle_execution_result(device_id, message, tools)
                
            elif message["type"] == "state_update":
                # å¤„ç†çŠ¶æ€æ›´æ–°
                tools.update_state(message["state"])
                
    except WebSocketDisconnect:
        manager.disconnect(device_id)
        logging.info(f"Device {device_id} disconnected")
```

### 3. æ•°æ®åº“é›†æˆ

#### 3.1 Supabaseé…ç½®
**æ–‡ä»¶ä½ç½®**: `droidrun/server/database.py`

```python
from supabase import create_client, Client
import os
from typing import Optional, Dict, Any

class SupabaseManager:
    def __init__(self):
        self.url = os.getenv("SUPABASE_URL")
        self.key = os.getenv("SUPABASE_ANON_KEY")
        self.client: Client = create_client(self.url, self.key)
    
    async def register_device(self, device_id: str, device_info: Dict[str, Any]):
        """æ³¨å†Œè®¾å¤‡"""
        result = self.client.table("devices").upsert({
            "device_id": device_id,
            "device_name": device_info.get("name"),
            "status": "online",
            "last_seen": "now()"
        }).execute()
        return result
    
    async def log_task(self, device_id: str, task_description: str, result: Dict[str, Any]):
        """è®°å½•ä»»åŠ¡æ—¥å¿—"""
        result = self.client.table("task_logs").insert({
            "device_id": device_id,
            "task_description": task_description,
            "result": result
        }).execute()
        return result
```

#### 3.2 æ•°æ®åº“è¡¨ç»“æ„
```sql
-- è®¾å¤‡è¡¨
CREATE TABLE devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id TEXT UNIQUE NOT NULL,
    device_name TEXT,
    status TEXT DEFAULT 'offline',
    last_seen TIMESTAMP DEFAULT NOW(),
    user_id UUID REFERENCES auth.users(id),
    created_at TIMESTAMP DEFAULT NOW()
);

-- ä»»åŠ¡æ—¥å¿—è¡¨  
CREATE TABLE task_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id TEXT REFERENCES devices(device_id),
    task_description TEXT NOT NULL,
    result JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    duration_ms INTEGER,
    success BOOLEAN
);

-- ç”¨æˆ·è¡¨ (Supabase Authè‡ªåŠ¨åˆ›å»º)
-- è®¾å¤‡ä¼šè¯è¡¨
CREATE TABLE device_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id TEXT REFERENCES devices(device_id),
    session_start TIMESTAMP DEFAULT NOW(),
    session_end TIMESTAMP,
    is_active BOOLEAN DEFAULT true
);
```

### 4. é…ç½®å’Œéƒ¨ç½²

#### 4.1 ç¯å¢ƒé…ç½®
**æ–‡ä»¶ä½ç½®**: `droidrun/server/config.py`

```python
import os
from pydantic import BaseSettings

class Settings(BaseSettings):
    # Supabaseé…ç½®
    supabase_url: str = os.getenv("SUPABASE_URL")
    supabase_anon_key: str = os.getenv("SUPABASE_ANON_KEY")
    
    # LLMé…ç½®
    default_llm_provider: str = "GoogleGenAI"
    default_llm_model: str = "gemini-2.5-flash"
    
    # æœåŠ¡å™¨é…ç½®
    host: str = "0.0.0.0"
    port: int = 8000
    debug: bool = False
    
    # WebSocketé…ç½®
    websocket_timeout: int = 300  # 5åˆ†é’Ÿ
    max_connections_per_device: int = 1
    
    class Config:
        env_file = ".env"

settings = Settings()
```

#### 4.2 Dockeréƒ¨ç½²é…ç½®
**æ–‡ä»¶ä½ç½®**: `Dockerfile`

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶æºä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "droidrun.server.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 5. CLIå·¥å…·é€‚é…

#### 5.1 äº‘ç«¯CLIå·¥å…·
**æ–‡ä»¶ä½ç½®**: `droidrun/cli/main.py` (é‡å†™)

```python
@click.command()
@click.argument("command")
@click.option("--server-url", default="ws://localhost:8000", help="WebSocketæœåŠ¡å™¨åœ°å€")
@click.option("--device-id", required=True, help="ç›®æ ‡è®¾å¤‡ID")
@click.option("--timeout", default=300, help="ä»»åŠ¡è¶…æ—¶æ—¶é—´(ç§’)")
def run(command: str, server_url: str, device_id: str, timeout: int):
    """è¿è¡ŒDroidRunäº‘ç«¯å‘½ä»¤"""
    asyncio.run(run_cloud_command(command, server_url, device_id, timeout))

async def run_cloud_command(command: str, server_url: str, device_id: str, timeout: int):
    """æ‰§è¡Œäº‘ç«¯å‘½ä»¤"""
    import websockets
    import asyncio

    uri = f"{server_url}/ws/device/{device_id}"

    try:
        async with websockets.connect(uri) as websocket:
            # å‘é€ä»»åŠ¡
            task_id = str(uuid.uuid4())
            await websocket.send(json.dumps({
                "type": "new_task",
                "task_id": task_id,
                "command": command,
                "timeout": timeout
            }))

            click.echo(f"ä»»åŠ¡å·²æäº¤: {command}")
            click.echo(f"è®¾å¤‡ID: {device_id}")
            click.echo("ç­‰å¾…æ‰§è¡Œç»“æœ...")

            # ç­‰å¾…ç»“æœ
            async with asyncio.timeout(timeout):
                async for message in websocket:
                    data = json.loads(message)

                    if data.get("task_id") == task_id:
                        if data["type"] == "task_progress":
                            click.echo(f"è¿›åº¦: {data['progress']}")
                        elif data["type"] == "task_complete":
                            success = data.get("success", False)
                            result = data.get("result", "")

                            if success:
                                click.echo(f"âœ… ä»»åŠ¡å®Œæˆ: {result}")
                            else:
                                click.echo(f"âŒ ä»»åŠ¡å¤±è´¥: {result}")
                            break

    except websockets.exceptions.ConnectionClosed:
        click.echo("âŒ ä¸æœåŠ¡å™¨è¿æ¥æ–­å¼€")
    except asyncio.TimeoutError:
        click.echo(f"âŒ ä»»åŠ¡è¶…æ—¶ ({timeout}ç§’)")
    except Exception as e:
        click.echo(f"âŒ æ‰§è¡Œé”™è¯¯: {str(e)}")
```

## ğŸ“¦ ä¾èµ–ç®¡ç†

### 6.1 æ–°å¢ä¾èµ–åŒ…
**æ–‡ä»¶ä½ç½®**: `requirements.txt` (æ–°å¢)

```txt
# æ ¸å¿ƒæ¡†æ¶ä¾èµ–
click>=8.1.0
rich>=13.0.0
pydantic>=2.0.0
aiofiles>=23.0.0
python-dotenv>=1.0.0
typing_extensions

# LLMé›†æˆä¾èµ–
openai>=1.0.0
anthropic>=0.7.0
llama-index
llama-index-llms-openai
llama-index-llms-openai-like
llama-index-llms-google-genai
llama-index-llms-deepseek
llama-index-llms-anthropic
llama-index-llms-ollama

# å›¾åƒå¤„ç†
pillow>=10.0.0

# äº‘ç«¯æœåŠ¡ä¾èµ–
fastapi==0.104.1
uvicorn[standard]==0.24.0
websockets==12.0
supabase==2.3.0
python-multipart==0.0.6

# ç›‘æ§å’Œæ—¥å¿—
posthog==6.0.2
```

### 6.2 é¡¹ç›®ç»“æ„è°ƒæ•´
```
droidrun/
â”œâ”€â”€ droidrun/
â”‚   â”œâ”€â”€ agent/              # AIæ™ºèƒ½ä½“ (ä¿æŒä¸å˜)
â”‚   â”œâ”€â”€ tools/              # å·¥å…·å±‚ (ä»…WebSocket)
â”‚   â”‚   â”œâ”€â”€ __init__.py     # å¯¼å‡ºWebSocketTools
â”‚   â”‚   â”œâ”€â”€ tools.py        # æŠ½è±¡åŸºç±»
â”‚   â”‚   â””â”€â”€ websocket.py    # WebSocketå·¥å…· (ä¸»è¦å®ç°)
â”‚   â”œâ”€â”€ server/             # äº‘ç«¯æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py         # FastAPIä¸»æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ websocket_handler.py  # WebSocketå¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ database.py     # Supabaseæ•°æ®åº“ç®¡ç†
â”‚   â”‚   â””â”€â”€ config.py       # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ cli/                # CLIå·¥å…· (ä»…äº‘ç«¯æ¨¡å¼)
â”‚   â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
â”œâ”€â”€ docs/                   # æ–‡æ¡£
â”œâ”€â”€ static/                 # é™æ€èµ„æº
â”œâ”€â”€ tests/                  # æµ‹è¯•
â”œâ”€â”€ docker-compose.yml      # Dockerç¼–æ’
â”œâ”€â”€ Dockerfile              # Dockeré…ç½®
â””â”€â”€ .env.example            # ç¯å¢ƒå˜é‡ç¤ºä¾‹
```

## ğŸ”„ å®æ–½ç­–ç•¥

### 7.1 ä¸€æ­¥åˆ°ä½æ”¹é€ æ–¹æ¡ˆ

#### å®Œæ•´æ”¹é€ ä»»åŠ¡æ¸…å• (4å‘¨)
- [ ] **Week 1**: WebSocketé€šä¿¡å±‚
  - [ ] å®ç°WebSocketToolså®Œæ•´ç±»
  - [ ] åˆ›å»ºFastAPI WebSocketæœåŠ¡å™¨
  - [ ] å»ºç«‹WebSocketé€šä¿¡åè®®
  - [ ] å®ç°æ‰€æœ‰Toolsæ¥å£æ–¹æ³•

- [ ] **Week 2**: æ•°æ®åº“å’ŒæœåŠ¡é›†æˆ
  - [ ] é›†æˆSupabaseæ•°æ®åº“
  - [ ] å®ç°è®¾å¤‡æ³¨å†Œå’Œç®¡ç†
  - [ ] æ·»åŠ ä»»åŠ¡æ—¥å¿—è®°å½•
  - [ ] é›†æˆDroidAgentä¸WebSocketTools

- [ ] **Week 3**: é”™è¯¯å¤„ç†å’Œä¼˜åŒ–
  - [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶
  - [ ] å®ç°çŠ¶æ€åŒæ­¥å’Œç¼“å­˜
  - [ ] æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†
  - [ ] CLIå·¥å…·äº‘ç«¯åŒ–é€‚é…

- [ ] **Week 4**: éƒ¨ç½²å’Œæµ‹è¯•
  - [ ] Dockerå®¹å™¨åŒ–éƒ¨ç½²
  - [ ] å…¨é¢æµ‹è¯•å’Œè°ƒè¯•
  - [ ] ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ
  - [ ] æ–‡æ¡£æ›´æ–°å’Œå‘å¸ƒ

### 7.2 ç§»é™¤ç»„ä»¶
- **åˆ é™¤AdbTools**: å®Œå…¨ç§»é™¤ADBç›¸å…³ä»£ç 
- **åˆ é™¤ADBä¾èµ–**: ç§»é™¤æ‰€æœ‰ADBç›¸å…³ä¾èµ–åŒ…
- **ç®€åŒ–CLI**: åªä¿ç•™äº‘ç«¯æ¨¡å¼ï¼Œç§»é™¤æœ¬åœ°æ¨¡å¼é€‰é¡¹
- **æ¸…ç†é…ç½®**: ç§»é™¤ADBç›¸å…³é…ç½®é¡¹

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 8.1 å•å…ƒæµ‹è¯•
**æ–‡ä»¶ä½ç½®**: `tests/test_websocket_tools.py`

```python
import pytest
import asyncio
from unittest.mock import AsyncMock, MagicMock
from droidrun.tools.websocket import WebSocketTools

@pytest.fixture
async def websocket_tools():
    mock_websocket = AsyncMock()
    tools = WebSocketTools(mock_websocket, "test_device")
    return tools, mock_websocket

@pytest.mark.asyncio
async def test_tap_by_index(websocket_tools):
    tools, mock_websocket = websocket_tools

    # æ¨¡æ‹ŸWebSocketå“åº”
    mock_websocket.send_json = AsyncMock()
    tools._wait_for_execution_result = AsyncMock(return_value={"success": True})

    result = await tools.tap_by_index(5)

    assert result == True
    mock_websocket.send_json.assert_called_once_with({
        "action": "tap",
        "index": 5
    })
```

### 8.2 é›†æˆæµ‹è¯•
**æ–‡ä»¶ä½ç½®**: `tests/test_websocket_integration.py`

```python
import pytest
from fastapi.testclient import TestClient
from droidrun.server.main import app

@pytest.fixture
def client():
    return TestClient(app)

def test_websocket_connection(client):
    with client.websocket_connect("/ws/device/test_device") as websocket:
        # æµ‹è¯•è¿æ¥å»ºç«‹
        websocket.send_json({"type": "ping"})
        data = websocket.receive_json()
        assert data["type"] == "pong"
```

### 8.3 ç«¯åˆ°ç«¯æµ‹è¯•
- ä½¿ç”¨Androidæ¨¡æ‹Ÿå™¨è¿›è¡Œå®Œæ•´æµç¨‹æµ‹è¯•
- æµ‹è¯•WebSocketè¿æ¥ç¨³å®šæ€§
- éªŒè¯AIæ™ºèƒ½ä½“æ‰§è¡Œæ•ˆæœ
- æ€§èƒ½å’Œå»¶è¿Ÿæµ‹è¯•

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 9.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ
```bash
# 1. å®‰è£…ä¾èµ–
pip install -e ".[dev]"

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envæ–‡ä»¶ï¼Œå¡«å…¥Supabaseé…ç½®

# 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
uvicorn droidrun.server.main:app --reload --host 0.0.0.0 --port 8000

# 4. æµ‹è¯•WebSocketè¿æ¥
python -m droidrun.cli.main "æ‰“å¼€è®¾ç½®" --device-id test_device
```

### 9.2 Dockeréƒ¨ç½²
```bash
# 1. æ„å»ºé•œåƒ
docker build -t droidrun-server .

# 2. è¿è¡Œå®¹å™¨
docker run -d \
  --name droidrun-server \
  -p 8000:8000 \
  -e SUPABASE_URL=your_supabase_url \
  -e SUPABASE_ANON_KEY=your_supabase_key \
  droidrun-server

# 3. ä½¿ç”¨docker-compose (æ¨è)
docker-compose up -d
```

### 9.3 äº‘ç«¯éƒ¨ç½² (é˜¿é‡Œäº‘)
```yaml
# docker-compose.yml
version: '3.8'
services:
  droidrun-server:
    build: .
    ports:
      - "8000:8000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - DEFAULT_LLM_PROVIDER=GoogleGenAI
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 10.1 æ—¥å¿—é…ç½®
**æ–‡ä»¶ä½ç½®**: `droidrun/server/logging_config.py`

```python
import logging
import sys
from pathlib import Path

def setup_logging(debug: bool = False):
    """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
    level = logging.DEBUG if debug else logging.INFO

    # åˆ›å»ºæ—¥å¿—ç›®å½•
    log_dir = Path("logs")
    log_dir.mkdir(exist_ok=True)

    # é…ç½®æ ¼å¼
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )

    # æ–‡ä»¶å¤„ç†å™¨
    file_handler = logging.FileHandler(log_dir / "droidrun_server.log")
    file_handler.setFormatter(formatter)

    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)

    # é…ç½®æ ¹æ—¥å¿—å™¨
    root_logger = logging.getLogger()
    root_logger.setLevel(level)
    root_logger.addHandler(file_handler)
    root_logger.addHandler(console_handler)
```

### 10.2 æ€§èƒ½ç›‘æ§
- WebSocketè¿æ¥æ•°ç›‘æ§
- ä»»åŠ¡æ‰§è¡Œæ—¶é—´ç»Ÿè®¡
- é”™è¯¯ç‡å’ŒæˆåŠŸç‡è¿½è¸ª
- è®¾å¤‡åœ¨çº¿çŠ¶æ€ç›‘æ§

## âš ï¸ æ³¨æ„äº‹é¡¹å’Œé™åˆ¶

### 11.1 åŠŸèƒ½é™åˆ¶
äº‘ç«¯åŒ–æ¶æ„çš„åŠŸèƒ½é™åˆ¶ï¼š
- **ç½‘ç»œä¾èµ–**: å¿…é¡»æœ‰ç¨³å®šçš„ç½‘ç»œè¿æ¥
- **å»¶è¿Ÿå¢åŠ **: WebSocketé€šä¿¡ä¼šæœ‰ç½‘ç»œå»¶è¿Ÿ
- **è®¾å¤‡æƒé™**: ä¾èµ–Androidæ— éšœç¢æœåŠ¡æƒé™
- **ç³»ç»Ÿé™åˆ¶**: å—Androidç³»ç»Ÿå®‰å…¨é™åˆ¶

### 11.2 æ€§èƒ½è€ƒè™‘
- **ç½‘ç»œå»¶è¿Ÿ**: WebSocketé€šä¿¡ä¼šå¢åŠ å»¶è¿Ÿ
- **è¿æ¥ç¨³å®šæ€§**: éœ€è¦å®ç°é‡è¿æœºåˆ¶
- **å¹¶å‘é™åˆ¶**: å•è®¾å¤‡å»ºè®®é™åˆ¶å¹¶å‘è¿æ¥æ•°
- **èµ„æºæ¶ˆè€—**: äº‘ç«¯æœåŠ¡å™¨éœ€è¦è¶³å¤Ÿèµ„æº

### 11.3 å®‰å…¨è€ƒè™‘
- **è®¾å¤‡è®¤è¯**: å®ç°è®¾å¤‡IDéªŒè¯
- **æ•°æ®åŠ å¯†**: WebSocketä½¿ç”¨WSSåŠ å¯†
- **è®¿é—®æ§åˆ¶**: é™åˆ¶è®¾å¤‡è®¿é—®æƒé™
- **æ—¥å¿—è„±æ•**: é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [WebSocketé€šä¿¡åè®®è§„èŒƒ](docs/websocket-protocol.md)
- [éƒ¨ç½²è¿ç»´æŒ‡å—](docs/deployment-guide.md)
- [APIæ¥å£æ–‡æ¡£](docs/api-reference.md)
- [æ•…éšœæ’é™¤æŒ‡å—](docs/troubleshooting.md)

---

**æ”¹é€ å®Œæˆåï¼ŒDroidRunå°†æˆä¸ºä¸€ä¸ªå¼ºå¤§çš„äº‘ç«¯AIè®¾å¤‡æ§åˆ¶å¹³å°ï¼Œæ”¯æŒè¿œç¨‹æ§åˆ¶ã€å¤šè®¾å¤‡ç®¡ç†å’Œå®æ—¶åä½œã€‚**
